

<!DOCTYPE html>
<html lang="en">

<head>
    <title>语义实验解析 - ce_amtic&#39;s</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="ce_amtic">
<meta name="description" content="词法分析只要把关键字，终结符和非终结符等等区分开就好，而语义分析的任务就复杂的多了。">
<meta name="keywords" content="">

<link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml">

    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="/css/journal.css?37388782">

<link rel="icon" href="/img/favicon.ico">


<link id="hljsThemeLight" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-light.min.css" crossorigin="anonymous">
<link disabled id="hljsThemeDark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark.min.css" crossorigin="anonymous">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif|Noto+Serif+SC|Fira+Code|Montserrat">
<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Material+Icons">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>
<body>
<div id="top"></div>

<div id="app">
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            <a class="a-block drawer-menu-item false" href="/">
                Home
            </a>

            
                
                    <a class="a-block drawer-menu-item false"
                       href="/search">
                        Search
                    </a>
                
                    <a class="a-block drawer-menu-item false"
                       href="/categories">
                        Categories
                    </a>
                
                    <a class="a-block drawer-menu-item false"
                       href="/tags">
                        Tags
                    </a>
                
                    <a class="a-block drawer-menu-item false"
                       href="/archives">
                        Archive
                    </a>
                
                    <a class="a-block drawer-menu-item false"
                       href="/about">
                        About
                    </a>
                
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            ce_amtic&#39;s
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">ce_amtic&#39;s</div>
        <div class="single-column-header-subtitle"></div>
    </a>
</div>

<div ref="sideContainer" class="side-container">
    <a class="a-block nav-head false" href="/">
        <div class="nav-title">
            ce-amtic's.
        </div>
        <div class="nav-subtitle">
            信仰は儚き人間の為に
        </div>
    </a>

    <div class="nav-link-list">
        
            
                <a class="a-block nav-link-item false"
                   href="/search">
                    Search
                </a>
            
                <a class="a-block nav-link-item false"
                   href="/categories">
                    Categories
                </a>
            
                <a class="a-block nav-link-item false"
                   href="/tags">
                    Tags
                </a>
            
                <a class="a-block nav-link-item false"
                   href="/archives">
                    Archive
                </a>
            
                <a class="a-block nav-link-item false"
                   href="/about">
                    About
                </a>
            
        
    </div>

    
    <div class="nav-footer">
        <!--button class="nav-footer-button" type="button" v-if="window.matchMedia('(prefers-color-scheme: dark)').matches">
            <i class="material-icons footer-button">dark_mode</i>
        </button>
        <button class="nav-footer-button" type="button" v-else>
            <i class="material-icons footer-button">light_mode</i>
        </button><br-->
        Built with <a href="https://hexo.io/" target="_blank">Hexo</a><br>
        
        Theme <a href="https://github.com/ce-amtic/hexo-theme-journal" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>
        
        &copy; 2024 <a target="_blank" rel="noopener" href="https://github.com/ce-amtic/ce-amtic.github.io/">ce_amtic</a>
    </div>
</div>

<div ref="extraContainer" class="extra-container">
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>

        
    </div>
</div>

    <!-- <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
            inlineMath:  [ ["$", "$"] ],
            displayMath: [ ["$$","$$"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a'],
            ignoreClass:"comment-content"
        },
        "HTML-CSS": {
            availableFonts: ["STIX","TeX"],
            showMathMenu: true
        }
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
</script> -->
<!-- <script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<script>
  MathJax = {
    tex: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"],
      ],
    },
    svg: {
      fontCache: "global",
    },
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"
></script>




<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper"
                 style="background-image: url('https://s2.loli.net/2024/06/08/L2fiacduehZCIDv.png')">
                <div class="post-title">
                    语义实验解析
                    <div class="post-meta">
                        <time datetime="2024-06-08T09:23:00.000Z" itemprop="datePublished">
                            2024-06-08 17:23
                        </time>&nbsp;
                        
                        
                        <i class="material-icons no-hover" style="">folder</i>
                        
                        <a href='/categories/笔记/'>笔记</a>
                        
                        
    
                        
                        
                        <i class="material-icons no-hover" style="">label</i>
                        
                        <a href='/tags/编译原理/'>编译原理</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">整体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%83%A8%E8%A7%A3%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">分部解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">栈空间管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">2.2.</span> <span class="toc-text">符号表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E5%92%8C%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.4.</span> <span class="toc-text">条件分支和循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84%E5%B1%95%E5%B9%B3"><span class="toc-number">2.5.</span> <span class="toc-text">初始化数组展平</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
                    <p>我要成为bison高手.jpg</p>
<p>本文是对C++实现的SysY语言编译器的解析，仓库地址<a target="_blank" rel="noopener" href="https://github.com/ce-amtic/sysy-compiler/tree/master">ce-amtic&#x2F;sysy-compiler</a>。编译器不分前后端，直接产生汇编语言。</p>
<h3 id="整体设计"><a href="#整体设计" class="headerlink" title="整体设计"></a>整体设计</h3><p>工程目录如下：</p>
<pre><code class="hljs plain">.
├── assembly.hpp
├── ast_node.hpp
├── compiler.hpp
├── symbols.hpp
├── sysy.l
├── sysy.y
├── plot/
│   └── tree.py
├── out/                # outputs
└── tests/              # testcase</code></pre>

<p>其中<code>sysy.l</code>为词法分析器；<code>sysy.y</code>是语义分析的主程序，其中定义了语法规则和动作；<code>ast_node.hpp</code>定义了语法树节点的抽象类型；<code>assembly.hpp</code>定义了Assembly类，用于实现汇编代码的生成；<code>symbols.hpp</code>定义了符号类Symbol和符号表Symbols；<code>compiler.hpp</code>定义了CompileState, RuntimeStack类，用于维护编译时状态。</p>
<p>根据bison的相关原理，<code>sysy.y</code>会在语义分析时，按定义的产生式规则递归语法树，但是并不会将其显示存储。语法树可视化的相关代码被放在了<code>plot/tree.py</code>中，这个脚本会根据<code>detail.txt</code>中的内容绘制语法树，后者按递归顺序记录了归约过程中的每条产生式。</p>
<p>详细信息请阅读GitHub上的<a target="_blank" rel="noopener" href="https://github.com/ce-amtic/sysy-compiler/blob/master/README.md">指南文档</a>。</p>
<h3 id="分部解析"><a href="#分部解析" class="headerlink" title="分部解析"></a>分部解析</h3><h4 id="栈空间管理"><a href="#栈空间管理" class="headerlink" title="栈空间管理"></a>栈空间管理</h4><p>每个过程栈空间会在进入过程之后立刻确定，以便满足16字节对齐的要求。这一过程通过在CompileState类中维护一个offset变量来实现，它记录了当前用到的栈空间相对于基址的偏移。在编译器完成对过程的解析时，会计算offset峰值并对齐到16字节，回填到过程开始的位置。</p>
<p>本程序中，函数的参数是通过栈来传递的，对于callee来说，它的第一个参数在<code>8(%rbp)</code>的位置，第二个在<code>16(%rbp)</code>，以此类推。对于caller而言，编译器会记录其函数调用传参的情况，并提前预留出栈空间，相关逻辑实现在CompileState中。</p>
<h4 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h4><p>对于一个符号，会记录它的类别，数值（或偏移量），以及数组维度之类的附加信息，它们被抽象为Symbol类。</p>
<p>符号表是一个<code>vector&lt;map&lt;string, Symbol&gt; &gt;</code>类型的映射，其中第一层<code>vector</code>用于维护代码中的层级关系，第二层<code>map</code>用于按名称查找。</p>
<h4 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h4><p>表达式被定义为Exp类，它可能是函数调用，算式或它们的组合。本程序根据如下的规则简化代码编写：</p>
<blockquote>
<p><strong>针对表达式的规则</strong></p>
<div class="plain-text">
<p>如果一个表达式有计算结果，这个结果要么是一个可以编译时计算的常数，要么对应到栈上的一个临时变量。对于前者，类中记录这个常数；对于后者，类中记录这个变量相对于栈基的偏移。</p>
</div>
</blockquote>

<p>在这一规则下，完成表达式计算的相关逻辑就会变得十分简单，代码在<code>sysy.y</code>里Exp相关的语义动作中。</p>
<h4 id="条件分支和循环"><a href="#条件分支和循环" class="headerlink" title="条件分支和循环"></a>条件分支和循环</h4><p>通过预生成跳转指令和回填的方式完成条件语句，代码在Cond和Stmt相关的语义动作中。</p>
<p>循环可以视为加入了回跳的条件语句，代码为While相关的语义动作。对于break, continue等影响控制流的语句，使用RuntimeStack类来维护运行状态，并完成跳转回填相关逻辑。</p>
<h4 id="初始化数组展平"><a href="#初始化数组展平" class="headerlink" title="初始化数组展平"></a>初始化数组展平</h4><p>针对<code>int a[4][3][2] = &#123;0, &#123;0&#125;, &#123;&#123;0&#125;&#125;&#125;</code>等等初始化方式，我将后面的每个大括号抽象为一个ExpList类，其中定义了<code>vector</code>容器用于维护嵌套大括号的情况，并在语法动作中记录层级信息。</p>
<p>在解析数组初始化时，我在ExpList类中定义了dfsArray方法，用于递归地解析这种层级信息，将初始值展平为一维数组。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>更细节的实现，请直接参考<a target="_blank" rel="noopener" href="https://github.com/ce-amtic/sysy-compiler/tree/master">代码</a>中的注释。</p>

                </div>
            </div>
    
            
<nav class="post-pagination">
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="/post/ml-notes/">
        Next post<br>ML Notes
    </a>
    
</nav>


    
            
<p style="opacity: 0.6; padding: 30px 15px" align="center">
    <small>Comments have been disabled for this content</small>
</p>


        </div>
    </div>
    <div class="single-column-footer">
    <!--button class="nav-footer-button" type="button" v-if="localStorage.theme === 'dark'" v-on:click="toggleDark">
        Light Mode
    </button>
    <button class="nav-footer-button" type="button" v-else v-on:click="toggleDark">
        Dark Mode
    </button><br-->
    Built with <a href="https://hexo.io/" target="_blank">Hexo</a><br>
    
    Theme <a href="https://github.com/ce-amtic/hexo-theme-journal" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>
    
    &copy; 2024 <a href="https://ce-amtic.github.io">ce_amtic</a>
</div>
</div>

</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.17/vue.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scroll/14.2.1/smooth-scroll.min.js" crossorigin="anonymous"></script>
<script src="/js/journal.min.js?3255942"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<script src="/js/clipboard.js"></script>
<script src="/js/darkmode.js"></script>



</body>
</html>
